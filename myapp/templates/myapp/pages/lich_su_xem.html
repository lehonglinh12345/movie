{% extends 'myapp/layout/base.html' %}
{% load static %}

{% block content %}
<style>
  :root {
    --primary-color: #2563eb; /* Blue for primary actions */
    --secondary-color: #1a1a2e; /* Dark blue-gray for background consistency */
    --accent-color: #e11d48; /* Red for highlights, matching previous artifact */
    --text-color: #e5e7eb; /* Light gray for text, matching previous artifact */
    --card-bg: #ffffff; /* White for card background */
    --shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    --transition: all 0.3s ease;
  }

  body {
    background: linear-gradient(135deg, var(--secondary-color) 0%, #2a2a4e 100%);
    font-family: 'Inter', 'Montserrat', sans-serif;
    color: var(--text-color);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container {
    max-width: 1440px;
    margin: 0 auto;
    padding: 1.5rem;
  }

  .movie-card {
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }

  .movie-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .movie-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .movie-card:hover img {
    transform: scale(1.08);
  }

  .movie-card .overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
  }

  .movie-card .timestamp {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    background: rgba(0, 0, 0, 0.7);
    color: var(--text-color);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .cta-button {
    background: var(--primary-color);
    color: var(--text-color);
    padding: 0.5rem 1.25rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .cta-button:hover {
    background: #1d4ed8;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .empty-state {
    background: linear-gradient(145deg, var(--accent-color), #d1d5db);
    border-radius: 12px;
    padding: 3rem;
    box-shadow: var(--shadow);
    text-align: center;
  }

  .empty-state svg {
    color: var(--secondary-color);
    margin: 0 auto;
  }

  h3 {
    font-weight: 700;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
    margin-bottom: 1.5rem;
    font-size: 2rem;
  }

  h3 i {
    color: var(--accent-color);
    font-size: 1.5rem;
    transition: var(--transition);
  }

  h3:hover i {
    transform: scale(1.15);
  }

  h3::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    width: 50%;
    height: 3px;
    background: linear-gradient(to right, var(--accent-color), var(--primary-color));
    transition: var(--transition);
  }

  h3:hover::after {
    width: 70%;
  }

  @media (max-width: 640px) {
    .container { padding: 0.5rem; }
    h3 { font-size: 1.6rem; }
    h3 i { font-size: 1.2rem; }
    .movie-card img { height: 180px; }
    .cta-button { padding: 0.5rem 1rem; font-size: 0.85rem; }
    .empty-state { padding: 2rem; }
  }
</style>

<div class="container mx-auto px-4 py-12">
  <h3><i class="fa fa-history"></i> Lịch sử xem phim</h3>

  {% if lich_su %}
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    {% for item in lich_su %}
    <div class="movie-card">
      <div class="relative">
        <img src="{{ item.phim.anh_bia_url }}" alt="Poster phim {{ item.phim.ten_phim }}" class="lazy" data-src="{{ item.phim.anh_bia_url }}" loading="lazy">
        <div class="overlay"></div>
        <div class="timestamp">
          {{ item.thoi_gian_bat_dau|date:"d/m/Y" }}
        </div>
      </div>
      <div class="p-5">
        <h5 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-1" title="{{ item.phim.ten_phim }}">
          {{ item.phim.ten_phim }}
        </h5>
        <p class="text-sm text-gray-400 mb-4">
          Đã xem: {{ item.thoi_gian_bat_dau|date:"d/m/Y H:i" }}
        </p>
        <a href="{% url 'chitietphim' item.phim.maphim %}" class="cta-button">
          <i class="fa fa-play"></i> Xem lại
        </a>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state py-16">
    <svg class="mx-auto h-14 w-14" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16" />
    </svg>
    <p class="text-lg text-gray-600 mt-4">Bạn chưa xem phim nào.</p>
    <a href="{% url 'home' %}" class="cta-button mt-6">
      <i class="fa fa-film"></i> Khám phá phim ngay
    </a>
  </div>
  {% endif %}
</div>

<script>
  // Optimized Lazy Loading
  const lazyImages = document.querySelectorAll('img.lazy');
  if ('IntersectionObserver' in window) {
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          obs.unobserve(img);
        }
      });
    }, { rootMargin: '150px', threshold: 0.1 });
    lazyImages.forEach(img => observer.observe(img));
  } else {
    lazyImages.forEach(img => {
      img.src = img.dataset.src;
      img.classList.remove('lazy');
    });
  }
</script>
{% endblock %}